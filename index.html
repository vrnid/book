import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc } from 'firebase/firestore';

// Define the main App component for the guestbook
const App = () => {
    // State variables to manage Firebase instances, user info, messages, and loading state
    const [app, setApp] = useState(null);
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null); // Stores the current user's ID
    const [messages, setMessages] = useState([]); // Stores the list of guestbook messages
    const [newMessage, setNewMessage] = useState(''); // Stores the content of the new message input
    const [loading, setLoading] = useState(true); // Manages loading state for initial data fetch
    const [sending, setSending] = useState(false); // Manages sending state for new messages
    const [showConfirmModal, setShowConfirmModal] = useState(false); // State for delete confirmation modal
    const [messageToDelete, setMessageToDelete] = useState(null); // Stores the ID of the message to be deleted
    const [selectedImage, setSelectedImage] = useState(null); // Stores the selected image file object
    const [imagePreview, setImagePreview] = useState(null); // Stores the Data URL for image preview
    const [imageError, setImageError] = useState(''); // Stores image upload error messages

    const fileInputRef = useRef(null); // Ref to clear the file input field

    // Global variables provided by the Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- ç®¡ç†å‘˜è®¾ç½® ---
    const ADMIN_USER_ID = "14352607679857038531"; // æ‚¨å¯ä»¥ä¿®æ”¹è¿™ä¸ªID

    // Effect hook for Firebase initialization and authentication
    useEffect(() => {
        const initFirebase = async () => {
            try {
                // Initialize Firebase app
                const firebaseApp = initializeApp(firebaseConfig);
                setApp(firebaseApp);

                // Get Auth and Firestore instances
                const authInstance = getAuth(firebaseApp);
                const dbInstance = getFirestore(firebaseApp);
                setAuth(authInstance);
                setDb(dbInstance);

                // Listen for authentication state changes
                onAuthStateChanged(authInstance, async (user) => {
                    if (user) {
                        // User is signed in
                        setUserId(user.uid);
                    } else {
                        // No user is signed in, sign in anonymously or with custom token
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(authInstance, initialAuthToken);
                            } else {
                                await signInAnonymously(authInstance);
                            }
                        } catch (error) {
                            console.error('Firebase authentication error:', error);
                            // Set a random UUID as userId if sign-in fails
                            setUserId(crypto.randomUUID());
                        }
                    }
                    setLoading(false); // Authentication is ready, stop loading
                });
            } catch (error) {
                console.error('Failed to initialize Firebase:', error);
                setLoading(false);
            }
        };

        initFirebase();
    }, [appId, firebaseConfig, initialAuthToken]); // Dependencies for this effect

    // Effect hook for fetching and listening to messages
    useEffect(() => {
        // Only fetch messages if db and userId are available
        if (db && userId) {
            // Define the Firestore collection path for public messages
            // This structure ensures data is stored under the specific app ID and marked as public
            const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/guestbook_messages`);

            // Create a query to order messages by their creation timestamp (descending)
            // Note: Firestore's `orderBy` requires an index for more complex queries.
            // For simplicity and to avoid index issues, we'll fetch and sort in memory if needed,
            // but `serverTimestamp` is often ordered naturally.
            // If complex sorting is needed, client-side sorting is preferred to avoid index creation.
            const q = query(messagesCollectionRef /*, orderBy('timestamp', 'desc')*/);

            // Set up a real-time listener for messages
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const fetchedMessages = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    fetchedMessages.push({
                        id: doc.id,
                        ...data,
                        // Convert Firestore timestamp to Date object for consistent sorting
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
                    });
                });
                // Sort messages by timestamp in descending order (most recent first)
                fetchedMessages.sort((a, b) => b.timestamp - a.timestamp);
                setMessages(fetchedMessages);
            }, (error) => {
                console.error("Error fetching messages:", error);
            });

            // Clean up the listener when the component unmounts or dependencies change
            return () => unsubscribe();
        }
    }, [db, userId, appId]); // Dependencies for this effect

    // Function to handle image file selection
    const handleImageChange = (e) => {
        const file = e.target.files[0];
        setImageError(''); // Clear previous errors

        if (file) {
            // Check file size (500KB limit for base64 in Firestore, leaves room for text)
            if (file.size > 500 * 1024) { // 500 KB
                setImageError('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 500KB çš„å›¾ç‰‡ã€‚');
                setSelectedImage(null);
                setImagePreview(null);
                if (fileInputRef.current) fileInputRef.current.value = ""; // Clear file input
                return;
            }

            setSelectedImage(file);
            const reader = new FileReader();
            reader.onloadend = () => {
                setImagePreview(reader.result); // Set base64 string for preview
            };
            reader.readAsDataURL(file); // Read file as Data URL (Base64)
        } else {
            setSelectedImage(null);
            setImagePreview(null);
        }
    };

    // Function to handle sending a new message
    const handleSendMessage = async () => {
        if (newMessage.trim() === '' && !selectedImage) return; // Don't send empty messages or no message/image

        setSending(true); // Set sending state to true
        setImageError(''); // Clear any image errors

        let imageData = null;
        if (selectedImage) {
            // Re-check image size before sending, in case state was manipulated
            if (selectedImage.size > 500 * 1024) {
                setImageError('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 500KB çš„å›¾ç‰‡ã€‚');
                setSending(false);
                return;
            }
            // Read image as Base64 for storage
            const reader = new FileReader();
            reader.readAsDataURL(selectedImage);
            imageData = await new Promise((resolve) => {
                reader.onloadend = () => resolve(reader.result);
            });
        }

        try {
            // Define the Firestore collection path
            const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/guestbook_messages`);
            // Add a new document to the 'guestbook_messages' collection
            await addDoc(messagesCollectionRef, {
                userId: userId, // Store the sender's user ID
                message: newMessage, // Store the message content
                imageData: imageData, // Store the Base64 image data (if any)
                timestamp: serverTimestamp(), // Use Firestore's server timestamp for accurate ordering
            });
            setNewMessage(''); // Clear the input field after sending
            setSelectedImage(null); // Clear selected image
            setImagePreview(null); // Clear image preview
            if (fileInputRef.current) fileInputRef.current.value = ""; // Clear file input
        } catch (error) {
            console.error('Error adding message:', error);
            // Optionally show an error message to the user
        } finally {
            setSending(false); // Reset sending state
        }
    };

    // Function to show the confirmation modal for deleting a message
    const confirmDelete = (messageId) => {
        setMessageToDelete(messageId);
        setShowConfirmModal(true);
    };

    // Function to handle the actual deletion of a message
    const handleDeleteMessage = async () => {
        if (!messageToDelete) return; // If no message is selected for deletion, do nothing

        setShowConfirmModal(false); // Close the confirmation modal
        try {
            // Define the Firestore document reference for the message to be deleted
            const messageDocRef = doc(db, `artifacts/${appId}/public/data/guestbook_messages`, messageToDelete);
            await deleteDoc(messageDocRef); // Delete the document
            setMessageToDelete(null); // Clear the message to delete state
        } catch (error) {
            console.error('Error deleting message:', error);
            // Optionally show an error message to the user
        }
    };

    // Render the guestbook UI
    return (
        <div className="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-100 p-4 sm:p-6 lg:p-8 flex items-center justify-center font-sans">
            <div className="bg-white p-6 sm:p-8 rounded-3xl shadow-2xl shadow-indigo-200 w-full max-w-2xl transform transition-all duration-500 hover:scale-[1.01] border border-indigo-100">
                <h1 className="text-4xl sm:text-5xl font-extrabold text-center bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-indigo-700 mb-8 border-b-2 border-indigo-100 pb-4">
                    ğŸ‰ ç•™è¨€æ¿ ğŸ‰
                </h1>

                {loading ? (
                    <div className="flex justify-center items-center py-8">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-purple-500"></div>
                        <p className="ml-4 text-gray-600 text-lg">åŠ è½½ä¸­...</p>
                    </div>
                ) : (
                    <>
                        <div className="mb-8 p-4 bg-indigo-50 rounded-2xl border border-indigo-200 shadow-inner">
                            <p className="text-gray-700 text-sm mb-3">
                                æ‚¨çš„ç”¨æˆ·ID: <span className="font-semibold text-indigo-700 break-all">{userId}</span>
                                {userId === ADMIN_USER_ID && (
                                    <span className="ml-2 px-2 py-1 bg-green-200 text-green-800 text-xs font-bold rounded-full">ç®¡ç†å‘˜</span>
                                )}
                                <br />
                                æ‚¨å¯ä»¥ä½¿ç”¨æ­¤IDä¸å…¶ä»–ç”¨æˆ·åŒºåˆ†å¼€ã€‚
                            </p>
                            <textarea
                                className="w-full p-4 border border-indigo-300 rounded-xl focus:ring-4 focus:ring-indigo-400/50 focus:border-indigo-500 outline-none transition-all duration-300 resize-y min-h-[100px] max-h-[250px] shadow-sm text-gray-800 placeholder-gray-400 text-base"
                                placeholder="åœ¨è¿™é‡Œç•™ä¸‹æ‚¨çš„ç•™è¨€æˆ–ä¸Šä¼ å›¾ç‰‡..."
                                value={newMessage}
                                onChange={(e) => setNewMessage(e.target.value)}
                                rows="3"
                            ></textarea>
                            <input
                                type="file"
                                accept="image/*"
                                onChange={handleImageChange}
                                className="w-full mt-4 p-3 border border-indigo-300 rounded-xl text-gray-700 file:mr-4 file:py-2 file:px-5 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-200 file:text-indigo-700 hover:file:bg-indigo-300 transition-colors duration-200 cursor-pointer shadow-sm"
                                ref={fileInputRef}
                            />
                            {imagePreview && (
                                <div className="mt-4 flex flex-col items-center p-3 bg-white rounded-xl shadow-md border border-gray-200">
                                    <p className="text-sm text-gray-600 mb-3 font-medium">å›¾ç‰‡é¢„è§ˆ:</p>
                                    <img src={imagePreview} alt="å›¾ç‰‡é¢„è§ˆ" className="max-w-full h-56 object-contain rounded-lg shadow-inner border border-gray-100" />
                                </div>
                            )}
                            {imageError && (
                                <p className="text-red-600 text-sm mt-3 text-center font-medium">{imageError}</p>
                            )}
                            <button
                                className={`w-full mt-5 px-6 py-3 rounded-xl text-white font-bold text-xl shadow-lg transform transition-all duration-300
                                    ${sending ? 'bg-gradient-to-r from-purple-400 to-indigo-400 cursor-not-allowed' : 'bg-gradient-to-r from-purple-600 to-indigo-700 hover:from-purple-700 hover:to-indigo-800 active:scale-95'}`}
                                onClick={handleSendMessage}
                                disabled={sending || (newMessage.trim() === '' && !selectedImage)}
                            >
                                {sending ? 'å‘é€ä¸­...' : 'å‘é€ç•™è¨€'}
                            </button>
                            <p className="text-xs text-gray-500 mt-3 text-center">
                                æ³¨æ„ï¼šä¸ºç¡®ä¿æ€§èƒ½å’Œå­˜å‚¨é™åˆ¶ï¼Œå›¾ç‰‡å¤§å°åº”å°äº 500KBã€‚å¤§å‹å›¾ç‰‡å¯èƒ½æ— æ³•æ­£å¸¸æ˜¾ç¤ºã€‚
                            </p>
                        </div>

                        <div className="border-t-2 border-indigo-100 pt-6">
                            <h2 className="text-2xl font-bold text-indigo-700 mb-5">æ‰€æœ‰ç•™è¨€</h2>
                            {messages.length === 0 ? (
                                <p className="text-gray-500 text-center py-4 text-lg">è¿˜æ²¡æœ‰ç•™è¨€ã€‚æˆä¸ºç¬¬ä¸€ä¸ªç•™è¨€çš„äººå§ï¼</p>
                            ) : (
                                <div className="space-y-5 max-h-[450px] overflow-y-auto pr-2 custom-scrollbar">
                                    {messages.map((msg) => (
                                        <div
                                            key={msg.id}
                                            className="bg-white p-5 rounded-2xl shadow-lg border border-gray-200 transform transition-all duration-300 hover:shadow-xl hover:translate-y-[-2px]"
                                        >
                                            {msg.imageData && (
                                                <img src={msg.imageData} alt="ç•™è¨€å›¾ç‰‡" className="w-full h-auto max-h-64 object-contain rounded-lg mb-3 border border-gray-200 shadow-sm" />
                                            )}
                                            <p className="text-gray-800 text-lg mb-3 break-words leading-relaxed">
                                                {msg.message}
                                            </p>
                                            <div className="flex justify-between items-center border-t border-gray-100 pt-3">
                                                <span className="text-sm text-gray-500 flex items-center">
                                                    <span className="font-semibold text-indigo-600 mr-2 break-all">@{msg.userId}</span>
                                                    {msg.userId === ADMIN_USER_ID && (
                                                        <span className="ml-1 px-1.5 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded-full">ç®¡ç†å‘˜</span>
                                                    )}
                                                    <span className="text-gray-400 ml-2">â€¢</span>
                                                    <span className="ml-2">{msg.timestamp.toLocaleString()}</span>
                                                </span>
                                                {/* Only show delete button if the message belongs to the current user OR if the current user is the admin */}
                                                {(userId === msg.userId || userId === ADMIN_USER_ID) && (
                                                    <button
                                                        onClick={() => confirmDelete(msg.id)}
                                                        className="ml-3 p-2 bg-red-100 text-red-600 rounded-full text-xs hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-300 focus:ring-offset-1 transition-all duration-200 shadow-sm"
                                                        aria-label="åˆ é™¤ç•™è¨€"
                                                    >
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                                            <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </>
                )}

                {/* Custom Confirmation Modal */}
                {showConfirmModal && (
                    <div className="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
                        <div className="bg-white p-7 rounded-2xl shadow-xl transform scale-105 w-full max-w-md border border-gray-200">
                            <h3 className="text-2xl font-bold mb-4 text-gray-800 text-center">ç¡®è®¤åˆ é™¤</h3>
                            <p className="text-gray-700 mb-7 text-center leading-relaxed">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
                            <div className="flex justify-center space-x-4">
                                <button
                                    onClick={() => setShowConfirmModal(false)}
                                    className="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all duration-200 font-medium shadow-sm"
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    onClick={handleDeleteMessage}
                                    className="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-all duration-200 font-medium shadow-sm"
                                >
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// Export the App component as default
export default App;
