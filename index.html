<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™è¨€æ¿</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä¸ºç•™è¨€åˆ—è¡¨è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px; /* æ»šåŠ¨æ¡çš„å®½åº¦ */
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e0e7ff; /* è½¨é“èƒŒæ™¯è‰² */
            border-radius: 10px; /* è½¨é“åœ†è§’ */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #a78bfa; /* æ»šåŠ¨æ¡æ»‘å—çš„é¢œè‰² */
            border-radius: 10px; /* æ»‘å—åœ†è§’ */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #8b5cf6; /* æ»‘å—æ‚¬åœæ—¶çš„é¢œè‰² */
        }
    </style>
</head>
<body class="font-sans">
    <div id="app" class="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-100 p-4 sm:p-6 lg:p-8 flex items-center justify-center">
        <!-- ä¸»è¦å†…å®¹å°†åœ¨ JavaScript ä¸­åŠ¨æ€æ’å…¥ -->
        <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-2xl shadow-indigo-200 w-full max-w-2xl transform transition-all duration-500 hover:scale-[1.01] border border-indigo-100">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-center bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-indigo-700 mb-8 border-b-2 border-indigo-100 pb-4">
                ğŸ‰ ç•™è¨€æ¿ ğŸ‰
            </h1>

            <!-- åŠ è½½çŠ¶æ€æ˜¾ç¤º -->
            <div id="loading-spinner" class="flex justify-center items-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-purple-500"></div>
                <p class="ml-4 text-gray-600 text-lg">åŠ è½½ä¸­...</p>
            </div>

            <!-- ä¸»è¦å†…å®¹åŒºåŸŸï¼Œåœ¨åŠ è½½å®Œæˆåæ˜¾ç¤º -->
            <div id="main-content" class="hidden">
                <div class="mb-8 p-4 bg-indigo-50 rounded-2xl border border-indigo-200 shadow-inner">
                    <p class="text-gray-700 text-sm mb-3">
                        æ‚¨çš„ç”¨æˆ·ID: <span id="currentUserId" class="font-semibold text-indigo-700 break-all"></span>
                        <span id="adminTag" class="hidden ml-2 px-2 py-1 bg-green-200 text-green-800 text-xs font-bold rounded-full">ç®¡ç†å‘˜</span>
                        <br />
                        æ‚¨å¯ä»¥ä½¿ç”¨æ­¤IDä¸å…¶ä»–ç”¨æˆ·åŒºåˆ†å¼€ã€‚
                    </p>
                    <textarea
                        id="newMessageInput"
                        class="w-full p-4 border border-indigo-300 rounded-xl focus:ring-4 focus:ring-indigo-400/50 focus:border-indigo-500 outline-none transition-all duration-300 resize-y min-h-[100px] max-h-[250px] shadow-sm text-gray-800 placeholder-gray-400 text-base"
                        placeholder="åœ¨è¿™é‡Œç•™ä¸‹æ‚¨çš„ç•™è¨€æˆ–ä¸Šä¼ å›¾ç‰‡..."
                        rows="3"
                    ></textarea>
                    <input
                        type="file"
                        id="imageInput"
                        accept="image/*"
                        class="w-full mt-4 p-3 border border-indigo-300 rounded-xl text-gray-700 file:mr-4 file:py-2 file:px-5 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-200 file:text-indigo-700 hover:file:bg-indigo-300 transition-colors duration-200 cursor-pointer shadow-sm"
                    />
                    <div id="imagePreviewContainer" class="hidden mt-4 flex flex-col items-center p-3 bg-white rounded-xl shadow-md border border-gray-200">
                        <p class="text-sm text-gray-600 mb-3 font-medium">å›¾ç‰‡é¢„è§ˆ:</p>
                        <img id="imagePreview" src="" alt="å›¾ç‰‡é¢„è§ˆ" class="max-w-full h-56 object-contain rounded-lg shadow-inner border border-gray-100" />
                    </div>
                    <p id="imageError" class="hidden text-red-600 text-sm mt-3 text-center font-medium"></p>
                    <button
                        id="sendMessageBtn"
                        class="w-full mt-5 px-6 py-3 rounded-xl text-white font-bold text-xl shadow-lg transform transition-all duration-300 bg-gradient-to-r from-purple-600 to-indigo-700 hover:from-purple-700 hover:to-indigo-800 active:scale-95"
                    >
                        å‘é€ç•™è¨€
                    </button>
                    <p class="text-xs text-gray-500 mt-3 text-center">
                        æ³¨æ„ï¼šä¸ºç¡®ä¿æ€§èƒ½å’Œå­˜å‚¨é™åˆ¶ï¼Œå›¾ç‰‡å¤§å°åº”å°äº 500KBã€‚å¤§å‹å›¾ç‰‡å¯èƒ½æ— æ³•æ­£å¸¸æ˜¾ç¤ºã€‚
                    </p>
                </div>

                <div class="border-t-2 border-indigo-100 pt-6">
                    <h2 class="text-2xl font-bold text-indigo-700 mb-5">æ‰€æœ‰ç•™è¨€</h2>
                    <p id="noMessagesText" class="text-gray-500 text-center py-4 text-lg hidden">è¿˜æ²¡æœ‰ç•™è¨€ã€‚æˆä¸ºç¬¬ä¸€ä¸ªç•™è¨€çš„äººå§ï¼</p>
                    <div id="messagesList" class="space-y-5 max-h-[450px] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- ç•™è¨€å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
        <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4 hidden">
            <div class="bg-white p-7 rounded-2xl shadow-xl transform scale-105 w-full max-w-md border border-gray-200">
                <h3 class="text-2xl font-bold mb-4 text-gray-800 text-center">ç¡®è®¤åˆ é™¤</h3>
                <p class="text-gray-700 mb-7 text-center leading-relaxed">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
                <div class="flex justify-center space-x-4">
                    <button
                        id="cancelDeleteBtn"
                        class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all duration-200 font-medium shadow-sm"
                    >
                        å–æ¶ˆ
                    </button>
                    <button
                        id="confirmDeleteBtn"
                        class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-all duration-200 font-medium shadow-sm"
                    >
                        åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs - ç±»å‹ä¸º module ä»¥æ”¯æŒ import è¯­æ³• -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å…¨å±€å˜é‡æ¥æ¨¡æ‹Ÿ React çš„ state
        let app;
        let db;
        let auth;
        let userId = null;
        let messages = [];
        let newMessageText = ''; // ç•™è¨€æ–‡æœ¬æ¡†çš„å€¼
        let selectedImageFile = null; // é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶å¯¹è±¡
        let currentImagePreview = null; // å›¾ç‰‡é¢„è§ˆçš„ Data URL
        let currentImageError = ''; // å›¾ç‰‡é”™è¯¯ä¿¡æ¯
        let isSending = false; // æ˜¯å¦æ­£åœ¨å‘é€ç•™è¨€
        let isModalShown = false; // æ¨¡æ€æ¡†æ˜¯å¦æ˜¾ç¤º
        let messageToDeleteId = null; // è¦åˆ é™¤çš„ç•™è¨€ID

        const ADMIN_USER_ID = "YOUR_ADMIN_USER_ID_HERE"; // <-- è¯·å°†æ­¤æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ç”¨æˆ·IDï¼

        // Firebase é…ç½®ä¿¡æ¯
        // IMPORTANT: è¯·å°†æ­¤å¤„æ›¿æ¢ä¸ºæ‚¨çš„ Firebase é¡¹ç›®çš„å®é™…é…ç½®ã€‚
        // è®¿é—® Firebase æ§åˆ¶å° (console.firebase.google.com) -> é¡¹ç›®è®¾ç½® (Project settings) -> æ‚¨çš„åº”ç”¨ (Your apps) -> é€‰æ‹©æ‚¨çš„ Web åº”ç”¨ -> é…ç½® (Config)ï¼Œå³å¯è·å–ã€‚
        // åŠ¡å¿…æ›¿æ¢ 'apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId' çš„å ä½ç¬¦ã€‚
        const firebaseConfig = {
          apiKey: "AIzaSyAXlYCZr6F1Nunieg7CDeYM0O_6iX1AZq0",
          authDomain: "wuzi-1ecf3.firebaseapp.com",
          projectId: "wuzi-1ecf3",
          storageBucket: "wuzi-1ecf3.firebasestorage.app",
          messagingSenderId: "274766423411",
          appId: "1:274766423411:web:ef1549f49be22bf53b9106",
          measurementId: "G-EFPFDMRSMZ"
        };

        // ä» firebaseConfig ä¸­æå– appIdï¼Œå› ä¸ºå®ƒæ˜¯ Firestore è·¯å¾„çš„ä¸€éƒ¨åˆ†
        const currentAppId = firebaseConfig.appId;

        // ç”Ÿæˆä¸€ä¸ªçŸ­çš„ç”¨æˆ·IDï¼ˆ8-10ä½ï¼‰
        function generateShortUserId(baseId) {
            // ä½¿ç”¨ baseIdï¼ˆæ— è®ºæ˜¯ Firebase UID è¿˜æ˜¯éšæœº UUIDï¼‰çš„å“ˆå¸Œå€¼æˆ–æˆªå–æ¥ç”ŸæˆçŸ­ID
            // è¿™é‡Œç®€å•åœ°æˆªå–å‰ 10 ä½ï¼Œç¡®ä¿é•¿åº¦åœ¨ 8-10 ä½ä¹‹é—´
            const shortId = baseId.substring(0, 10);
            return shortId;
        }

        // --- UI æ›´æ–°å‡½æ•° ---
        // æ­¤å‡½æ•°è´Ÿè´£æ ¹æ®å½“å‰å…¨å±€å˜é‡çš„çŠ¶æ€æ›´æ–°æ•´ä¸ªUI
        function updateUI() {
            // æ›´æ–°ç”¨æˆ·IDæ˜¾ç¤º
            const userIdSpan = document.getElementById('currentUserId');
            if (userIdSpan) {
                userIdSpan.textContent = userId;
                const adminTag = document.getElementById('adminTag');
                if (adminTag) {
                    if (userId === ADMIN_USER_ID) {
                        adminTag.classList.remove('hidden');
                    } else {
                        adminTag.classList.add('hidden');
                    }
                }
            }

            // æ§åˆ¶åŠ è½½çŠ¶æ€æ˜¾ç¤º
            const loadingSpinner = document.getElementById('loading-spinner');
            const mainContent = document.getElementById('main-content');
            if (loadingSpinner && mainContent) {
                if (isSending) { // å¦‚æœæ­£åœ¨å‘é€ï¼Œåªæ˜¾ç¤ºå‘é€æŒ‰é’®çš„åŠ è½½çŠ¶æ€
                    loadingSpinner.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                } else if (userId === null) { // åªæœ‰åœ¨é¦–æ¬¡åŠ è½½å’Œæœªè®¤è¯æ—¶æ‰æ˜¾ç¤ºå…¨å±åŠ è½½
                    loadingSpinner.classList.remove('hidden');
                    mainContent.classList.add('hidden');
                } else {
                    loadingSpinner.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                }
            }

            // æ›´æ–°ç•™è¨€æ–‡æœ¬æ¡†
            const newMessageInput = document.getElementById('newMessageInput');
            if (newMessageInput) {
                newMessageInput.value = newMessageText;
            }

            // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const imagePreviewImg = document.getElementById('imagePreview');
            if (imagePreviewContainer && imagePreviewImg) {
                if (currentImagePreview) {
                    imagePreviewImg.src = currentImagePreview;
                    imagePreviewContainer.classList.remove('hidden');
                } else {
                    imagePreviewContainer.classList.add('hidden');
                }
            }

            // æ›´æ–°å›¾ç‰‡é”™è¯¯ä¿¡æ¯
            const imageErrorElement = document.getElementById('imageError');
            if (imageErrorElement) {
                if (currentImageError) {
                    imageErrorElement.textContent = currentImageError;
                    imageErrorElement.classList.remove('hidden');
                } else {
                    imageErrorElement.classList.add('hidden');
                }
            }

            // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€å’Œæ ·å¼
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            if (sendMessageBtn) {
                const isDisabled = isSending || (newMessageText.trim() === '' && !selectedImageFile);
                sendMessageBtn.disabled = isDisabled;
                if (isSending) {
                    sendMessageBtn.textContent = 'å‘é€ä¸­...';
                    sendMessageBtn.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-indigo-700', 'hover:from-purple-700', 'hover:to-indigo-800', 'active:scale-95');
                    sendMessageBtn.classList.add('bg-gradient-to-r', 'from-purple-400', 'to-indigo-400', 'cursor-not-allowed');
                } else {
                    sendMessageBtn.textContent = 'å‘é€ç•™è¨€';
                    sendMessageBtn.classList.remove('bg-gradient-to-r', 'from-purple-400', 'to-indigo-400', 'cursor-not-allowed');
                    sendMessageBtn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-indigo-700', 'hover:from-purple-700', 'hover:to-indigo-800', 'active:scale-95');
                }
            }

            // æ›´æ–°ç•™è¨€åˆ—è¡¨
            const messagesListDiv = document.getElementById('messagesList');
            const noMessagesText = document.getElementById('noMessagesText');
            if (messagesListDiv && noMessagesText) {
                if (messages.length === 0) {
                    messagesListDiv.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
                    noMessagesText.classList.remove('hidden');
                } else {
                    noMessagesText.classList.add('hidden');
                    messagesListDiv.innerHTML = messages.map(msg => `
                        <div
                            class="bg-white p-5 rounded-2xl shadow-lg border border-gray-200 transform transition-all duration-300 hover:shadow-xl hover:translate-y-[-2px]"
                        >
                            ${msg.imageData ? `
                                <img src="${msg.imageData}" alt="ç•™è¨€å›¾ç‰‡" class="w-full h-auto max-h-64 object-contain rounded-lg mb-3 border border-gray-200 shadow-sm" />
                            ` : ''}
                            <p class="text-gray-800 text-lg mb-3 break-words leading-relaxed">
                                ${msg.message}
                            </p>
                            <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                                <span class="text-sm text-gray-500 flex items-center">
                                    <span class="font-semibold text-indigo-600 mr-2 break-all">@${msg.userId}</span>
                                    ${msg.userId === ADMIN_USER_ID ? `
                                        <span class="ml-1 px-1.5 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded-full">ç®¡ç†å‘˜</span>
                                    ` : ''}
                                    <span class="text-gray-400 ml-2">â€¢</span>
                                    <span class="ml-2">${msg.timestamp.toLocaleString()}</span>
                                </span>
                                ${(userId === msg.userId || userId === ADMIN_USER_ID) ? `
                                    <button
                                        data-message-id="${msg.id}"
                                        class="delete-btn ml-3 p-2 bg-red-100 text-red-600 rounded-full text-xs hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-300 focus:ring-offset-1 transition-all duration-200 shadow-sm"
                                        aria-label="åˆ é™¤ç•™è¨€"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                            <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');

                    // é‡æ–°ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
                    messagesListDiv.querySelectorAll('.delete-btn').forEach(button => {
                        button.onclick = () => confirmDelete(button.dataset.messageId);
                    });
                }
            }

            // æ§åˆ¶æ¨¡æ€æ¡†æ˜¾ç¤º
            const confirmModal = document.getElementById('confirmModal');
            if (confirmModal) {
                if (isModalShown) {
                    confirmModal.classList.remove('hidden');
                } else {
                    confirmModal.classList.add('hidden');
                }
            }
        }

        // --- äº‹ä»¶å¤„ç†å‡½æ•° ---

        // å¤„ç†ç•™è¨€æ–‡æœ¬è¾“å…¥
        function handleNewMessageInput(e) {
            newMessageText = e.target.value;
            updateUI(); // å®æ—¶æ›´æ–°UIä»¥å¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®
        }

        // å¤„ç†å›¾ç‰‡æ–‡ä»¶é€‰æ‹©
        async function handleImageChange(e) {
            const file = e.target.files[0];
            currentImageError = ''; // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯

            if (file) {
                if (file.size > 500 * 1024) { // 500 KB é™åˆ¶
                    currentImageError = 'å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 500KB çš„å›¾ç‰‡ã€‚';
                    selectedImageFile = null;
                    currentImagePreview = null;
                    e.target.value = ""; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
                    updateUI();
                    return;
                }

                selectedImageFile = file;
                const reader = new FileReader();
                reader.onloadend = () => {
                    currentImagePreview = reader.result;
                    updateUI(); // æ›´æ–°UIæ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                };
                reader.readAsDataURL(file); // è¯»å–æ–‡ä»¶ä¸º Data URL (Base64)
            } else {
                selectedImageFile = null;
                currentImagePreview = null;
                updateUI(); // æ›´æ–°UIæ¸…é™¤å›¾ç‰‡é¢„è§ˆ
            }
        }

        // å¤„ç†å‘é€ç•™è¨€
        async function handleSendMessage() {
            if (newMessageText.trim() === '' && !selectedImageFile) return;

            isSending = true;
            currentImageError = '';
            updateUI(); // æ›´æ–°UIæ˜¾ç¤ºå‘é€ä¸­çŠ¶æ€

            let imageData = null;
            if (selectedImageFile) {
                // å†æ¬¡æ£€æŸ¥å›¾ç‰‡å¤§å°ï¼Œä»¥é˜²åœ¨é€‰æ‹©åæ–‡ä»¶è¢«ç¯¡æ”¹
                if (selectedImageFile.size > 500 * 1024) {
                    currentImageError = 'å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 500KB çš„å›¾ç‰‡ã€‚';
                    isSending = false;
                    updateUI();
                    return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(selectedImageFile);
                imageData = await new Promise(resolve => {
                    reader.onloadend = () => resolve(reader.result);
                });
            }

            try {
                const messagesCollectionRef = collection(db, `artifacts/${currentAppId}/public/data/guestbook_messages`);
                await addDoc(messagesCollectionRef, {
                    userId: userId,
                    message: newMessageText,
                    imageData: imageData,
                    timestamp: serverTimestamp(),
                });
                newMessageText = ''; // æ¸…ç©ºæ–‡æœ¬æ¡†
                selectedImageFile = null; // æ¸…ç©ºé€‰ä¸­çš„å›¾ç‰‡
                currentImagePreview = null; // æ¸…ç©ºå›¾ç‰‡é¢„è§ˆ
                const imageInput = document.getElementById('imageInput');
                if (imageInput) imageInput.value = ""; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            } catch (error) {
                console.error('æ·»åŠ ç•™è¨€æ—¶å‡ºé”™:', error);
                // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºä¸€ä¸ªç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
            } finally {
                isSending = false;
                updateUI(); // å†æ¬¡æ›´æ–°UIä»¥æ¸…é™¤å‘é€çŠ¶æ€å’Œè¾“å…¥
            }
        }

        // æ˜¾ç¤ºç¡®è®¤åˆ é™¤æ¨¡æ€æ¡†
        function confirmDelete(id) {
            messageToDeleteId = id;
            isModalShown = true;
            updateUI(); // æ˜¾ç¤ºæ¨¡æ€æ¡†
        }

        // å¤„ç†å®é™…åˆ é™¤ç•™è¨€
        async function handleDeleteMessage() {
            if (!messageToDeleteId) return;

            isModalShown = false; // ç«‹å³éšè—æ¨¡æ€æ¡†
            updateUI(); // æ›´æ–°UIéšè—æ¨¡æ€æ¡†

            try {
                const messageDocRef = doc(db, `artifacts/${currentAppId}/public/data/guestbook_messages`, messageToDeleteId);
                await deleteDoc(messageDocRef);
                messageToDeleteId = null; // æ¸…ç©ºè¦åˆ é™¤çš„ç•™è¨€ID
            } catch (error) {
                console.error('åˆ é™¤ç•™è¨€æ—¶å‡ºé”™:', error);
                // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºä¸€ä¸ªç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
            }
        }

        // --- Firebase åˆå§‹åŒ–å’Œç›‘å¬å™¨è®¾ç½® ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // åœ¨è®¤è¯å®Œæˆå‰æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                updateUI();

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // æ— è®º Firebase è¿”å›ä»€ä¹ˆ UIDï¼Œéƒ½å°†å…¶æˆªå–ä¸º 10 ä½
                        userId = generateShortUserId(user.uid);
                    } else {
                        // ä½¿ç”¨åŒ¿åç™»å½•
                        try {
                            await signInAnonymously(auth);
                            // å¦‚æœåŒ¿åè®¤è¯æˆåŠŸï¼Œ user å¯¹è±¡ä¼šæ›´æ–°ï¼ŒonAuthStateChanged ä¼šå†æ¬¡è§¦å‘
                            // å› æ­¤è¿™é‡Œä¸éœ€è¦å†æ¬¡å¤„ç† userIdï¼Œå®ƒä¼šåœ¨ä¸‹æ¬¡è§¦å‘æ—¶è¢«æˆªå–
                        } catch (error) {
                            console.error('Firebase åŒ¿åè®¤è¯é”™è¯¯:', error);
                            // å¦‚æœåŒ¿åè®¤è¯å¤±è´¥ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªçŸ­çš„éšæœº UUID ä½œä¸ºå¤‡ç”¨ç”¨æˆ·ID
                            userId = generateShortUserId(crypto.randomUUID());
                        }
                    }
                    // è®¤è¯å®Œæˆåï¼Œéšè—åŠ è½½åŠ¨ç”»å¹¶è®¾ç½®Firestoreç›‘å¬å™¨
                    updateUI(); // ç«‹å³æ›´æ–° UI æ˜¾ç¤ºç”¨æˆ· ID å’Œå†…å®¹
                    setupFirestoreListener();
                });
            } catch (error) {
                console.error('åˆå§‹åŒ– Firebase å¤±è´¥:', error);
                userId = null; // åˆå§‹åŒ–å¤±è´¥ï¼Œå°†userIdè®¾ä¸ºnull
                updateUI(); // å³ä½¿åˆå§‹åŒ–å¤±è´¥ä¹Ÿæ›´æ–°UIï¼Œå¯èƒ½æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            }
        }

        // è®¾ç½® Firestore å®æ—¶ç›‘å¬å™¨
        function setupFirestoreListener() {
            if (db && userId) {
                const messagesCollectionRef = collection(db, `artifacts/${currentAppId}/public/data/guestbook_messages`);
                const q = query(messagesCollectionRef); // ç§»é™¤äº†orderByä»¥é¿å…ç´¢å¼•é—®é¢˜ï¼Œæ•°æ®å°†åœ¨å®¢æˆ·ç«¯æ’åº

                onSnapshot(q, (snapshot) => {
                    const fetchedMessages = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        fetchedMessages.push({
                            id: doc.id,
                            ...data,
                            // å°† Firestore timestamp è½¬æ¢ä¸º Date å¯¹è±¡ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯æ’åº
                            timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
                        });
                    });
                    // åœ¨å†…å­˜ä¸­æŒ‰æ—¶é—´æˆ³å€’åºæ’åº (æœ€æ–°ç•™è¨€åœ¨å‰)
                    messages = fetchedMessages.sort((a, b) => b.timestamp - a.timestamp);
                    updateUI(); // æ¯æ¬¡æ•°æ®æ›´æ–°æ—¶é‡æ–°æ¸²æŸ“ç•™è¨€åˆ—è¡¨
                }, (error) => {
                    console.error("è·å–ç•™è¨€æ—¶å‡ºé”™:", error);
                });
            }
        }

        // --- ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ ---
        function bindEventListeners() {
            document.getElementById('newMessageInput').addEventListener('input', handleNewMessageInput);
            document.getElementById('imageInput').addEventListener('change', handleImageChange);
            document.getElementById('sendMessageBtn').addEventListener('click', handleSendMessage);
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                isModalShown = false;
                updateUI();
            });
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteMessage);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– Firebase å¹¶ç»‘å®šäº‹ä»¶
        window.onload = () => {
            initFirebase();
            bindEventListeners();
        };
    </script>
</body>
</html>

